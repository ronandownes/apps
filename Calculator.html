<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Source Calculation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s;
        }

        body.night {
            background: #0a0a0a;
        }

        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.1);
            border: 2px solid #333;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 1000;
        }

        body.night .mode-toggle {
            background: rgba(255,255,255,0.1);
            border-color: #ddd;
            color: white;
        }

        .calculator {
            background: white;
            border-radius: 30px;
            padding: 35px 40px 40px 40px;
            box-shadow: 0 15px 60px rgba(0,0,0,0.15);
            max-width: 630px;
            width: 100%;
            border: 3px solid #e0e0e0;
            transition: all 0.3s;
        }

        body.night .calculator {
            background: #1a1a1a;
            border-color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .brand {
            color: #000;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 3px;
            transition: color 0.3s;
        }

        body.night .brand {
            color: #fff;
        }

        .model {
            color: #000;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 2px;
            transition: color 0.3s;
            text-align: right;
        }

        body.night .model {
            color: #fff;
        }

        .product-line {
            text-align: center;
            color: #8b4789;
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 15px;
            transition: color 0.3s;
        }

        body.night .product-line {
            color: #b388b3;
        }

        .display-container {
            background: white;
            border: 4px solid #000;
            border-radius: 15px;
            padding: 12px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        body.night .display-container {
            background: #0a0a0a;
            border-color: #666;
        }

        .display-inner {
            background: white;
            border: 2px solid #000;
            border-radius: 10px;
            padding: 18px;
            min-height: 110px;
            transition: all 0.3s;
        }

        body.night .display-inner {
            background: #0a0a0a;
            border-color: #444;
        }

        .mode-bar {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 10px;
            color: #666;
            font-weight: bold;
            transition: color 0.3s;
        }

        body.night .mode-bar {
            color: #999;
        }

        .display {
            color: #000;
            font-size: 32px;
            font-family: 'Courier New', monospace;
            text-align: right;
            min-height: 50px;
            overflow-x: auto;
            white-space: nowrap;
            transition: color 0.3s;
        }

        body.night .display {
            color: #4caf50;
        }

        .display-small {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            min-height: 16px;
            transition: color 0.3s;
        }

        body.night .display-small {
            color: #888;
        }

        .control-nav-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .ctrl-btn {
            background: white;
            color: #666;
            border: 3px solid #000;
            border-radius: 50%;
            padding: 0;
            width: 58px;
            height: 58px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        body.night .ctrl-btn {
            background: #0a0a0a;
            border-color: #666;
            color: #999;
        }

        .ctrl-btn:hover {
            transform: scale(1.08);
        }

        .ctrl-btn.purple {
            color: #7b1fa2;
        }

        body.night .ctrl-btn.purple {
            color: #b388b3;
        }

        .nav-pad {
            width: 140px;
            height: 115px;
            position: relative;
            border: 4px solid #000;
            border-radius: 40px;
            transition: border-color 0.3s;
            margin: 0 auto;
        }

        body.night .nav-pad {
            border-color: #666;
        }

        .nav-cross {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 85%;
        }

        .nav-btn {
            position: absolute;
            width: 32px;
            height: 32px;
            border: 3px solid #000;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.night .nav-btn {
            background: #0a0a0a;
            border-color: #666;
        }

        .nav-up { top: 0; left: 50%; transform: translateX(-50%); }
        .nav-down { bottom: 0; left: 50%; transform: translateX(-50%); }
        .nav-left { left: 0; top: 50%; transform: translateY(-50%); }
        .nav-right { right: 0; top: 50%; transform: translateY(-50%); }
        .nav-center { 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 38px; 
            height: 38px;
            border-radius: 8px;
        }

        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: stretch;
        }

        .top-row-spacer {
            grid-column: 3;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        
        .keypad-5col {
            grid-template-columns: repeat(5, 1fr);
            margin-top: 10px;
        }

        .key {
            background: white;
            border: 2px solid #000;
            border-radius: 10px;
            padding: 16px 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 68px;
            color: #000;
        }

        body.night .key {
            background: #0a0a0a;
            border-color: #666;
            color: #fff;
        }

        .key:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
        }

        body.night .key:hover {
            background: #1a1a1a;
        }

        .key-top {
            font-size: 13px;
            position: absolute;
            top: 5px;
            color: #b8860b;
            transition: color 0.3s;
            font-weight: bold;
        }

        body.night .key-top {
            color: #daa520;
        }

        .key-top.shift {
            color: #b8860b;
            font-weight: bold;
        }

        .key-top.alpha {
            color: #dc143c;
        }

        body.night .key-top.alpha {
            color: #ff6b6b;
        }

        .key-bottom {
            font-size: 10px;
            position: absolute;
            bottom: 4px;
            color: #dc143c;
            transition: color 0.3s;
            font-weight: bold;
        }

        body.night .key-bottom {
            color: #ff6b6b;
        }
        
        .key-bottom.gray {
            color: #888;
        }
        
        body.night .key-bottom.gray {
            color: #666;
        }
        
        .key.del-ac {
            background: #fff9e6;
        }
        
        body.night .key.del-ac {
            background: #3a3620;
        }

        .key-main {
            font-size: 17px;
            margin-top: 8px;
        }

        .key.number .key-main {
            font-size: 26px;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <button class="mode-toggle" onclick="toggleNightMode()">‚òÄÔ∏è / üåô</button>

    <div class="calculator">
        <div class="header">
            <div class="brand">CASI-OH?</div>
            <div class="model"></div>
        </div>
        
        <div class="product-line">Number ¬∑ x¬≤ ¬∑ f(x) ¬∑ Trig ¬∑ Geom ¬∑ xÃÑ=11.2 ¬∑ P(win)=0.9</div>
        
        <div class="display-container">
            <div class="display-inner">
                <div class="mode-bar">
                    <span id="modeIndicator">COMP</span>
                    <span>NORM</span>
                    <span id="angleIndicator">DEG</span>
                </div>
                <div class="display-small" id="previousDisplay"></div>
                <div class="display" id="display">0</div>
            </div>
        </div>

        <div class="control-nav-row">
            <button class="ctrl-btn purple" onclick="toggleShift()">SHIFT</button>
            <button class="ctrl-btn purple" onclick="insertVariable()">ALPHA</button>
            <div class="nav-pad">
                <div class="nav-cross">
                    <button class="nav-btn nav-up"></button>
                    <button class="nav-btn nav-down"></button>
                    <button class="nav-btn nav-left"></button>
                    <button class="nav-btn nav-right"></button>
                    <button class="nav-btn nav-center"></button>
                </div>
            </div>
            <button class="ctrl-btn" onclick="toggleMode()">MENU<br><span style="font-size:8px;">SETUP</span></button>
            <button class="ctrl-btn">ON</button>
        </div>

        <div class="top-row">
            <!-- Left side: OPTN and x¬≥ -->
            <button class="key" onclick="insertFunction('optn')">
                <span class="key-top shift">‚â°/‚éØ</span>
                <span class="key-main" style="font-size:18px;">OPTN</span>
            </button>
            <button class="key" onclick="insertFunction('cube')">
                <span class="key-top shift">¬≥‚àö</span>
                <span class="key-main" style="font-size:20px;"><i>x</i><sup style="font-size:14px;">3</sup></span>
            </button>
            
            <!-- Center spacer for nav pad -->
            <div class="top-row-spacer"></div>
            
            <!-- Right side: Abs and log‚ñ° -->
            <button class="key" onclick="insertFunction('abs')">
                <span class="key-top shift">i</span>
                <span class="key-main" style="font-size:19px;">Abs</span>
            </button>
            <button class="key" onclick="insertFunction('logbox')">
                <span class="key-top shift" style="font-size:11px;">10<sup style="font-size:8px;">‚ñ†</sup></span>
                <span class="key-main" style="font-size:18px;">log<span style="font-size:14px;">‚ñ†</span></span>
            </button>
        </div>

        <div class="keypad">
            <!-- Row 2 - 6 columns -->
            <button class="key" onclick="insertFunction('mixfrac')">
                <span class="key-top shift" style="font-size:11px;">‚ñ†/‚ñ°</span>
                <span class="key-main" style="font-size:20px;">‚ñ†<br style="line-height:0.3;">‚îÅ<br style="line-height:0.3;">‚ñ°</span>
            </button>
            <button class="key" onclick="insertFunction('sqrt')">
                <span class="key-top shift">¬≥‚àö</span>
                <span class="key-main" style="font-size:19px;">‚àö<span style="text-decoration:overline;">‚ñ†</span></span>
            </button>
            <button class="key" onclick="insertFunction('square')">
                <span class="key-top shift">i</span>
                <span class="key-main" style="font-size:20px;"><i>x</i><sup style="font-size:14px;">2</sup></span>
            </button>
            <button class="key" onclick="insertFunction('power')">
                <span class="key-top shift">‚ñ°‚àö</span>
                <span class="key-main" style="font-size:20px;"><i>x</i><sup style="font-size:14px;">‚ñ†</sup></span>
            </button>
            <button class="key" onclick="insertFunction('log')">
                <span class="key-top shift" style="font-size:11px;">10<sup style="font-size:8px;">‚ñ†</sup></span>
                <span class="key-main" style="font-size:19px;">log</span>
            </button>
            <button class="key" onclick="insertFunction('ln')">
                <span class="key-top shift" style="font-size:11px;"><i>e</i><sup style="font-size:8px;">‚ñ†</sup></span>
                <span class="key-main" style="font-size:19px;">ln</span>
            </button>

            <!-- Row 3 - 6 columns -->
            <button class="key" onclick="handleAKey()">
                <span class="key-bottom alpha">A</span>
                <span class="key-main" style="font-size:19px;">(‚àí)</span>
            </button>
            <button class="key" onclick="handleAlphaKey('B')">
                <span class="key-top shift" style="font-size:8px;">FACT</span>
                <span class="key-bottom alpha">B</span>
                <span class="key-main" style="font-size:19px;">¬∞'"</span>
            </button>
            <button class="key" onclick="handleAlphaClick('C')">
                <span class="key-top shift"><i>x</i>!</span>
                <span class="key-bottom alpha">C</span>
                <span class="key-main" style="font-size:20px;"><i>x</i><sup style="font-size:13px;">‚àí1</sup></span>
            </button>
            <button class="key" onclick="handleDKey()">
                <span class="key-top shift" style="font-size:10px;">sin<sup style="font-size:7px;">‚àí1</sup></span>
                <span class="key-bottom alpha">D</span>
                <span class="key-main" style="font-size:19px;">sin</span>
            </button>
            <button class="key" onclick="handleEKey()">
                <span class="key-top shift" style="font-size:10px;">cos<sup style="font-size:7px;">‚àí1</sup></span>
                <span class="key-bottom alpha">E</span>
                <span class="key-main" style="font-size:19px;">cos</span>
            </button>
            <button class="key" onclick="handleFKey()">
                <span class="key-top shift" style="font-size:10px;">tan<sup style="font-size:7px;">‚àí1</sup></span>
                <span class="key-bottom alpha">F</span>
                <span class="key-main" style="font-size:19px;">tan</span>
            </button>

            <!-- Row 4 - 6 columns -->
            <button class="key" onclick="storeFunction()">
                <span class="key-top shift" style="font-size:8px;">RECALL</span>
                <span class="key-main" style="font-size:18px;">STO</span>
            </button>
            <button class="key" onclick="toggleEng()">
                <span class="key-top shift">‚Üê</span>
                <span class="key-main" style="font-size:18px;">ENG</span>
            </button>
            <button class="key" onclick="insertChar('(')">
                <span class="key-top shift">,</span>
                <span class="key-main" style="font-size:22px;">(</span>
            </button>
            <button class="key" onclick="handleParenX()">
                <span class="key-bottom alpha"><i>x</i></span>
                <span class="key-main" style="font-size:22px;">)</span>
            </button>
            <button class="key" onclick="handleSDKey()">
                <span class="key-top shift" style="font-size:7px;">·µÉ·µá‚ÅÑ·∂ú‚Üî·µà‚ÅÑ·µâ</span>
                <span class="key-bottom alpha"><i>y</i></span>
                <span class="key-main" style="font-size:17px;">S‚ÜîD</span>
            </button>
            <button class="key" onclick="memoryPlus()">
                <span class="key-top shift">M‚àí</span>
                <span class="key-bottom alpha">M</span>
                <span class="key-main" style="font-size:19px;">M+</span>
            </button>
        </div>
        
        <div class="keypad keypad-5col">
            <!-- Row 5 - 5 columns -->
            <button class="key number" onclick="insertChar('7')">
                <span class="key-main">7</span>
            </button>
            <button class="key number" onclick="insertChar('8')">
                <span class="key-main">8</span>
            </button>
            <button class="key number" onclick="insertChar('9')">
                <span class="key-top shift">RESET</span>
                <span class="key-main">9</span>
            </button>
            <button class="key del-ac" onclick="deleteChar()">
                <span class="key-top shift">INS</span>
                <span class="key-bottom alpha">UNDO</span>
                <span class="key-main" style="font-size:19px;">DEL</span>
            </button>
            <button class="key del-ac" onclick="clearAll()">
                <span class="key-top shift">OFF</span>
                <span class="key-main" style="font-size:19px;">AC</span>
            </button>

            <!-- Row 6 - 5 columns -->
            <button class="key number" onclick="insertChar('4')">
                <span class="key-main">4</span>
            </button>
            <button class="key number" onclick="insertChar('5')">
                <span class="key-main">5</span>
            </button>
            <button class="key number" onclick="insertChar('6')">
                <span class="key-main">6</span>
            </button>
            <button class="key" onclick="insertChar('√ó')">
                <span class="key-bottom gray">nPr</span>
                <span class="key-main" style="font-size:22px;">√ó</span>
            </button>
            <button class="key" onclick="insertChar('√∑')">
                <span class="key-bottom gray">nCr</span>
                <span class="key-main" style="font-size:22px;">√∑</span>
            </button>

            <!-- Row 7 - 5 columns -->
            <button class="key number" onclick="insertChar('1')">
                <span class="key-bottom gray">Rnd</span>
                <span class="key-main">1</span>
            </button>
            <button class="key number" onclick="insertChar('2')">
                <span class="key-bottom gray" style="color:#4caf50;">Ran#</span>
                <span class="key-main">2</span>
            </button>
            <button class="key number" onclick="insertChar('3')">
                <span class="key-top shift">œÄ</span>
                <span class="key-bottom gray" style="color:#7b1fa2;">RanInt</span>
                <span class="key-main">3</span>
            </button>
            <button class="key" onclick="insertChar('+')">
                <span class="key-bottom gray">Pol</span>
                <span class="key-main" style="font-size:24px;">+</span>
            </button>
            <button class="key" onclick="insertChar('-')">
                <span class="key-bottom gray">Rec</span>
                <span class="key-main" style="font-size:24px;">‚àí</span>
            </button>

            <!-- Row 8 - 5 columns -->
            <button class="key number" onclick="insertChar('0')">
                <span class="key-main">0</span>
            </button>
            <button class="key number" onclick="insertChar('.')">
                <span class="key-main" style="font-size:28px;">.</span>
            </button>
            <button class="key" onclick="insertScientific()">
                <span class="key-main" style="font-size:15px;">√ó10<sup style="font-size:11px;"><i>x</i></sup></span>
            </button>
            <button class="key" onclick="insertAns()">
                <span class="key-top shift">%</span>
                <span class="key-main" style="font-size:18px;">Ans</span>
            </button>
            <button class="key" onclick="calculateApprox()">
                <span class="key-top shift">‚âà</span>
                <span class="key-main" style="font-size:22px;">=</span>
            </button>
        </div>
    </div>

    <script>
        let display = '';
        let previousDisplay = '';
        let mode = 'comp';
        let shiftMode = false;
        let alphaMode = false;
        let angleMode = 'deg';
        let lastAnswer = 0;
        let stoMode = false;
        let rclMode = false;
        
        let variables = {
            'A': 0, 'B': 0, 'C': 0, 'D': 0,
            'E': 0, 'F': 0, 'X': 0, 'Y': 0
        };
        let memoryM = 0;

        function toggleNightMode() {
            document.body.classList.toggle('night');
        }

        function updateDisplay() {
            document.getElementById('display').textContent = display || '\u00A0';
            document.getElementById('previousDisplay').textContent = previousDisplay;
            document.getElementById('angleIndicator').textContent = angleMode.toUpperCase();
        }

        function toggleShift() {
            shiftMode = !shiftMode;
        }

        function toggleDegRad() {
            angleMode = angleMode === 'deg' ? 'rad' : 'deg';
            updateDisplay();
        }

        function insertVariable() {
            alphaMode = true;
            previousDisplay = 'ALPHA: Press variable key';
            updateDisplay();
        }
        
        function handleVariableKey(varName) {
            if (stoMode) {
                const value = parseFloat(display) || 0;
                variables[varName] = value;
                previousDisplay = `${value} ‚Üí ${varName}`;
                stoMode = false;
                alphaMode = false;
                updateDisplay();
            } else if (rclMode) {
                const value = variables[varName];
                if (display === '0') {
                    display = value.toString();
                } else {
                    display += value.toString();
                }
                previousDisplay = `${varName} = ${value}`;
                rclMode = false;
                alphaMode = false;
                updateDisplay();
            } else if (alphaMode) {
                if (display === '0') {
                    display = varName;
                } else {
                    display += varName;
                }
                alphaMode = false;
                previousDisplay = '';
                updateDisplay();
            }
        }

        function insertChar(char) {
            if (display === '' || display === 'Error' || display === 'Math Error' || display === 'Syntax Error') {
                display = char;
            } else {
                display += char;
            }
            updateDisplay();
        }

        function insertScientific() {
            display += '√ó10^';
            updateDisplay();
        }

        function insertAns() {
            display += lastAnswer.toString();
            updateDisplay();
        }

        function insertFunction(func) {
            const functions = {
                'sqrt': '‚àö(',
                'cbrt': '‚àõ(',
                'square': '^2',
                'cube': '^3',
                'power': '^',
                'reciprocal': '^(-1)',
                'log': 'log_(',
                'logbox': 'log_(',
                'ln': 'ln(',
                'abs': 'Abs(',
                'negative': '(-',
                'optn': '',
                'mixfrac': '/'
            };

            if (shiftMode) {
                const shift = {
                    'cube': '‚àõ(',
                    'logbox': '10^(',
                    'ln': 'e^(',
                    'sqrt': '‚àõ(',
                    'power': '‚àö(',
                    'log': '10^('
                };
                
                if (shift[func]) {
                    if (display === '') {
                        display = shift[func];
                    } else {
                        display += shift[func];
                    }
                }
                shiftMode = false;
            } else {
                if (functions[func]) {
                    if (display === '') {
                        display = functions[func];
                    } else {
                        display += functions[func];
                    }
                }
            }
            updateDisplay();
        }

        function clearAll() {
            display = '';
            previousDisplay = '';
            updateDisplay();
        }

        function deleteChar() {
            if (display.length > 1) {
                display = display.slice(0, -1);
            } else {
                display = '';
            }
            updateDisplay();
        }

        function calculateApprox() {
            if (shiftMode) {
                // SHIFT + = gives decimal approximation
                calculateDecimal();
                shiftMode = false;
                return;
            }
            
            // Default = gives exact/fraction result
            calculateExact();
        }
        
        function calculateExact() {
            try {
                previousDisplay = display + ' =';
                
                // Auto-close unclosed brackets (fx-83/85 GTX behavior)
                let expression = display;
                const openCount = (expression.match(/\(/g) || []).length;
                const closeCount = (expression.match(/\)/g) || []).length;
                
                // Add missing closing parentheses automatically
                if (openCount > closeCount) {
                    expression += ')'.repeat(openCount - closeCount);
                }
                
                // Check if it's a simple fraction operation
                const fractionPattern = /^(\d+)\/(\d+)$/;
                const match = expression.match(fractionPattern);
                
                if (match) {
                    // Simple fraction - show as is or simplified
                    const num = parseInt(match[1]);
                    const den = parseInt(match[2]);
                    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                    const divisor = gcd(num, den);
                    const simpleNum = num / divisor;
                    const simpleDen = den / divisor;
                    
                    if (simpleDen === 1) {
                        display = simpleNum.toString();
                    } else {
                        display = `${simpleNum}/${simpleDen}`;
                    }
                } else {
                    // Try to convert result to fraction
                    let result = evaluateExpression(expression);
                    
                    if (isNaN(result) || !isFinite(result)) {
                        display = 'Math Error';
                    } else {
                        lastAnswer = result;
                        
                        // Format very large/small numbers in scientific notation
                        if (Math.abs(result) >= 1e10 || (Math.abs(result) < 1e-3 && result !== 0)) {
                            display = result.toExponential(10).replace(/e\+?/, '√ó10^');
                        } else {
                            // Convert decimal to fraction for reasonable numbers
                            const fraction = decimalToFraction(result);
                            display = fraction;
                        }
                    }
                }
            } catch (e) {
                display = 'Math Error';
            }
            updateDisplay();
        }
        
        function calculateDecimal() {
            try {
                previousDisplay = display + ' ‚âà';
                
                // Auto-close unclosed brackets (fx-83/85 GTX behavior)
                let expression = display;
                const openCount = (expression.match(/\(/g) || []).length;
                const closeCount = (expression.match(/\)/g) || []).length;
                
                // Add missing closing parentheses automatically
                if (openCount > closeCount) {
                    expression += ')'.repeat(openCount - closeCount);
                }
                
                let result = evaluateExpression(expression);
                
                if (isNaN(result) || !isFinite(result)) {
                    display = 'Math Error';
                } else {
                    lastAnswer = parseFloat(result.toFixed(10));
                    
                    // Format large/small numbers in scientific notation
                    if (Math.abs(result) >= 1e10 || (Math.abs(result) < 1e-3 && result !== 0)) {
                        display = result.toExponential(10).replace(/e\+?/, '√ó10^');
                    } else {
                        display = lastAnswer.toString();
                    }
                }
            } catch (e) {
                display = 'Math Error';
            }
            updateDisplay();
        }
        
        function evaluateExpression(expr) {
            let expression = expr;
            
            // Handle implicit multiplication after division (fx-83/85 GTX behavior)
            // 6√∑2(1+2) ‚Üí 6√∑(2(1+2))
            // 6√∑2œÄ ‚Üí 6√∑(2œÄ)
            expression = expression.replace(/√∑(\d+(?:\.\d+)?)\(/g, '√∑($1*(');
            expression = expression.replace(/√∑(\d+(?:\.\d+)?)([A-ZœÄe])/g, '√∑($1*$2)');
            
            // Convert √ó10^ notation to e notation (e.g., 5√ó10^7 becomes 5e7)
            expression = expression.replace(/(\d+\.?\d*)√ó10\^(-?\d+)/g, '$1e$2');
            
            // Handle custom base logarithms: log_a(b) = log(b)/log(a)
            expression = expression.replace(/log_(\d+(?:\.\d+)?)\(([^)]+)\)/g, '(Math.log10($2)/Math.log10($1))');
            
            expression = expression
                .replace(/√ó/g, '*')
                .replace(/√∑/g, '/')
                .replace(/‚àö\(/g, 'Math.sqrt(')
                .replace(/‚àõ\(/g, 'Math.cbrt(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/10\^\(/g, '(10**')
                .replace(/e\^\(/g, 'Math.exp(')
                .replace(/Abs\(/g, 'Math.abs(')
                .replace(/\^/g, '**');

            // Handle trig functions - auto-close if not closed
            expression = expression.replace(/sin\(/g, 'Math.sin(');
            expression = expression.replace(/cos\(/g, 'Math.cos(');
            expression = expression.replace(/tan\(/g, 'Math.tan(');
            expression = expression.replace(/sin‚Åª¬π\(/g, 'Math.asin(');
            expression = expression.replace(/cos‚Åª¬π\(/g, 'Math.acos(');
            expression = expression.replace(/tan‚Åª¬π\(/g, 'Math.atan(');

            expression = expression
                .replace(/A/g, `(${variables.A})`)
                .replace(/B/g, `(${variables.B})`)
                .replace(/C/g, `(${variables.C})`)
                .replace(/D/g, `(${variables.D})`)
                .replace(/E/g, `(${variables.E})`)
                .replace(/F/g, `(${variables.F})`)
                .replace(/X/g, `(${variables.X})`)
                .replace(/Y/g, `(${variables.Y})`);

            if (expression.includes('x')) {
                expression = expression.replace(/x/g, '1');
            }

            return eval(expression);
        }
        
        function decimalToFraction(decimal) {
            // Handle integers
            if (Number.isInteger(decimal)) {
                return decimal.toString();
            }
            
            // Handle negative
            const sign = decimal < 0 ? '-' : '';
            decimal = Math.abs(decimal);
            
            // Tolerance for fraction conversion
            const tolerance = 1.0E-6;
            let numerator = 1;
            let denominator = 1;
            let fraction = numerator / denominator;
            
            // Find best fraction within tolerance
            while (Math.abs(fraction - decimal) > tolerance && denominator < 10000) {
                if (fraction < decimal) {
                    numerator++;
                } else {
                    denominator++;
                    numerator = Math.round(decimal * denominator);
                }
                fraction = numerator / denominator;
            }
            
            // Simplify
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const divisor = gcd(numerator, denominator);
            numerator /= divisor;
            denominator /= divisor;
            
            // If denominator is 1 or very large, show decimal instead
            if (denominator === 1) {
                return sign + numerator.toString();
            } else if (denominator > 1000) {
                return sign + decimal.toFixed(8).replace(/\.?0+$/, '');
            } else {
                return sign + numerator + '/' + denominator;
            }
        }

        function toggleMode() {
            mode = mode === 'comp' ? 'table' : 'comp';
            document.getElementById('modeIndicator').textContent = mode.toUpperCase();
        }

        function storeFunction() {
            if (shiftMode) {
                rclMode = true;
                shiftMode = false;
                previousDisplay = 'RECALL: ALPHA then variable';
                updateDisplay();
            } else {
                stoMode = true;
                previousDisplay = 'STO: ALPHA then variable';
                updateDisplay();
            }
        }

        function toggleEng() {}

        function handleAlphaKey(varName) {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey(varName);
            }
        }
        
        function handleAlphaClick(varName) {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey(varName);
            } else {
                insertFunction('reciprocal');
            }
        }
        
        function handleDKey() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('D');
            } else {
                if (shiftMode) {
                    display += 'sin‚Åª¬π(';
                    shiftMode = false;
                } else {
                    display += 'sin(';
                }
                updateDisplay();
            }
        }
        
        function handleEKey() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('E');
            } else {
                if (shiftMode) {
                    display += 'cos‚Åª¬π(';
                    shiftMode = false;
                } else {
                    display += 'cos(';
                }
                updateDisplay();
            }
        }
        
        function handleFKey() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('F');
            } else {
                if (shiftMode) {
                    display += 'tan‚Åª¬π(';
                    shiftMode = false;
                } else {
                    display += 'tan(';
                }
                updateDisplay();
            }
        }
        
        function handleParenX() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('X');
            } else {
                insertChar(')');
            }
        }
        
        function handleSDKey() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('Y');
            } else {
                toggleDegRad();
            }
        }
        
        function handleAKey() {
            if (alphaMode || stoMode || rclMode) {
                handleVariableKey('A');
            } else {
                insertFunction('negative');
            }
        }
        
        function memoryPlus() {
            if (shiftMode) {
                const value = parseFloat(display) || 0;
                memoryM -= value;
                previousDisplay = `M- ‚Üí M = ${memoryM}`;
                shiftMode = false;
            } else if (alphaMode) {
                if (display === '' || display === '0') {
                    display = memoryM.toString();
                } else {
                    display += memoryM.toString();
                }
                previousDisplay = `M = ${memoryM}`;
                alphaMode = false;
            } else {
                const value = parseFloat(display) || 0;
                memoryM += value;
                previousDisplay = `M+ ‚Üí M = ${memoryM}`;
            }
            updateDisplay();
        }

        updateDisplay();
    </script>
</body>
</html>