<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sphere Calculator v4 - <?php echo date('Y-m-d_H-i-s'); ?></title>

<style>
:root{--ink:#000;--line:#cfcfcf;--muted:#666;--blue:#2563eb;--red:#dc2626}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#fff;color:var(--ink)}
.wrap{max-width:900px;margin:6px auto;padding:0 6px}
.card{border:1px solid var(--line);border-radius:10px;padding:8px}

/* TOP CONTROLS ROW */
.controls-row{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;margin-bottom:8px}
.block{border:1px solid var(--line);border-radius:8px;padding:6px}
.block h3{margin:0 0 3px;font-size:12px}
label{font-size:11px;color:var(--muted)}

/* LEFT SIDE: Shape title + Controls */
.left-panel{display:flex;flex-direction:column;gap:8px}
.shape-block{min-width:140px}
.shape-title{font-family:"Times New Roman",Times,serif;font-size:20px;font-weight:700}
.shape-sub{font-size:11px;color:var(--muted);margin-top:1px}

.controls-stack{display:flex;flex-direction:column;gap:6px}
.controls-stack .block{padding:8px}

/* RADIUS BLOCK - NOW TAKES MORE SPACE */
.radius-block{min-width:500px}
.radius-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.radius-header h3{margin:0}
.value-input{width:100px;border:2px solid var(--blue);border-radius:6px;padding:8px 12px;font-size:20px;text-align:center;font-family:"Times New Roman",Times,serif;font-weight:bold}
.value-input:focus{outline:none;border-color:#000}
.radius-display{font-family:"Times New Roman",Times,serif;font-size:18px;margin-bottom:6px}
.set-info{font-size:18px;font-weight:bold;margin-top:4px;font-style:italic;min-height:24px;text-align:center;font-family:"Times New Roman",Times,serif}
.set-info.integer{color:#16a34a}
.set-info.rational{color:#dc2626}

/* MAIN NUMBER LINE 0-11 */
.numline-wrap{margin-top:12px}
.numline{position:relative;height:28px;margin:0 20px}
.numline::before{content:"";position:absolute;left:0;right:0;top:50%;height:4px;background:var(--blue)}
.numline-tick{position:absolute;top:50%;transform:translate(-50%,-50%);width:3px;height:16px;background:var(--blue)}
.numline-tick.zero{width:4px;height:20px;background:#000}
.numline-dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:20px;height:20px;background:var(--blue);border-radius:50%;cursor:grab}
.numline-dot:active{cursor:grabbing}
.numline-labels{display:flex;justify-content:space-between;font-size:12px;margin:4px 20px 0;color:var(--blue)}

/* FRACTION OVERRIDE LINE 0-1 (RED) */
.fraction-line-wrap{margin-top:16px;border-top:1px solid var(--line);padding-top:12px}
.fraction-line-label{font-size:12px;color:var(--muted);margin-bottom:6px}
.fraction-line{position:relative;height:24px;margin:0 20px}
.fraction-line::before{content:"";position:absolute;left:0;right:0;top:50%;height:3px;background:var(--red)}
.fraction-line-dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;background:var(--red);border-radius:50%;cursor:grab}
.fraction-line-dot:active{cursor:grabbing}
.fraction-line-labels{display:flex;justify-content:space-between;font-size:11px;margin:4px 20px 0;color:var(--red)}

/* CONTROLS STACK */
.dprow{display:flex;gap:4px}
.dprow button{flex:1;border:1px solid var(--line);border-radius:6px;background:#fff;
  font-size:12px;padding:6px 8px;cursor:pointer}
.dprow button.active{background:#000;color:#fff}

.btnrow{display:grid;grid-template-columns:repeat(5,1fr);gap:3px}
.btnrow button{border:1px solid var(--line);border-radius:5px;background:#fff;
  font-size:11px;padding:5px 3px;cursor:pointer;line-height:1.2}
.btnrow button.active{background:#000;color:#fff}

.reveal-btn{width:100%;margin-top:8px;border:2px solid var(--line);border-radius:6px;
  background:#fff;font-size:14px;padding:10px;cursor:pointer;font-weight:bold;letter-spacing:0.5px}
.reveal-btn:hover{background:#f5f5f5}
.reveal-btn:active{background:#e5e5e5}

/* MAIN CONTENT */
.main{display:grid;grid-template-columns:220px 1fr 1fr;gap:10px;align-items:start}

/* DIAGRAM */
.diagram svg{width:100%;height:auto;display:block}
.formulas{font-family:"Times New Roman",Times,serif;margin-top:4px}
.formulas .f{font-size:16px;margin:2px 0}

/* RESULTS */
.calc{border:1px solid var(--line);border-radius:8px;padding:8px;transition:filter 0.3s ease}
.calc.hidden{filter:blur(5px)}
.calc h2{margin:0 0 6px;font-size:14px}
.line{font-family:"Times New Roman",Times,serif;font-size:18px;margin:3px 0}

/* BOXED ANSWERS - NEW STYLE */
.answer-container{margin:8px 0}
.answer-box{display:inline-block;border:2px solid #000;padding:8px 12px;font-family:"Times New Roman",Times,serif;font-size:22px;line-height:1.3}
.answer-box .label{font-style:italic}
.answer-box .value{font-weight:normal}
.answer-box .dp-info{font-size:18px;color:var(--muted);margin-left:10px;font-family:Segoe UI,Arial,sans-serif;font-weight:normal}

/* TRUNCATED + ROUNDING */
.trunc-line{font-family:"Times New Roman",Times,serif;font-size:16px;margin:4px 0;color:var(--muted)}
.round-arrow{font-size:18px;font-weight:bold;margin-left:6px}
.round-up{color:#16a34a}
.round-down{color:#dc2626}

@media(max-width:800px){
  .controls-row{grid-template-columns:1fr;gap:6px}
  .main{grid-template-columns:1fr}
  .radius-block{min-width:auto}
}
</style>
</head>

<body>
<div class="wrap">
<section class="card">

<!-- TOP CONTROLS ROW -->
<div class="controls-row">
  <div class="left-panel">
    <div class="block shape-block">
      <div class="shape-title">Sphere</div>
      <div class="shape-sub">3D shape</div>
    </div>
    
    <div class="controls-stack">
      <div class="block">
        <h3>Decimal places</h3>
        <div class="dprow" id="dpBtns"></div>
      </div>
      
      <div class="block">
        <h3>Units</h3>
        <div class="btnrow" id="unitBtns"></div>
      </div>
      
      <div class="block" style="border:none;padding:0">
        <button class="reveal-btn" id="revealBtn">Reveal</button>
      </div>
    </div>
  </div>

  <div class="block radius-block">
    <div class="radius-header">
      <h3>Radius (must be integer)</h3>
      <input type="number" class="value-input" id="valueInput" min="0" max="11" step="0.01" value="7">
    </div>
    <div class="radius-display" id="radiusDisplay"><i>r</i> = 7</div>
    <div class="set-info integer" id="setInfo">Integer value radius (r ∈ ℤ⁺)</div>
    
    <div class="numline-wrap">
      <div class="numline" id="numline"></div>
      <div class="numline-labels" id="numlineLabels"></div>
    </div>
    
    <div class="fraction-line-wrap">
      <div class="fraction-line-label">0 ≤ <i>d</i> < 1 number line (add fraction to integer)</div>
      <div class="fraction-line" id="fractionLine"></div>
      <div class="fraction-line-labels" id="fractionLineLabels"></div>
    </div>
  </div>
</div>

<!-- MAIN: Diagram + Surface Area + Volume -->
<div class="main">
  <div class="diagram-area">
    <div class="diagram">
      <svg viewBox="0 0 260 260" aria-label="Sphere diagram">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5"
                  markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#000"/>
          </marker>
        </defs>
        <!-- Sphere representation -->
        <circle cx="130" cy="130" r="105" fill="none" stroke="#000" stroke-width="3"/>
        <!-- Inner circle to give 3D effect -->
        <circle cx="130" cy="130" r="85" fill="none" stroke="#000" stroke-width="1.5" stroke-dasharray="4,4"/>
        <line x1="130" y1="130" x2="235" y2="130" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
        <text id="rLabel" x="138" y="112" font-size="18"
              font-family="Times New Roman" font-style="italic">r</text>
        <!-- A label inside sphere -->
        <text x="130" y="170" font-size="24" font-family="Times New Roman" font-weight="bold"
              text-anchor="middle" dominant-baseline="middle">[A]</text>
      </svg>
    </div>
    <div class="formulas">
      <div class="f"><i>A</i> = 4π<i>r</i>²</div>
      <div class="f"><i>V</i> = <sup>4</sup>⁄<sub>3</sub>π<i>r</i>³</div>
    </div>
  </div>

  <div class="calc" id="surfaceAreaCalc">
    <h2>Surface Area</h2>
    <div class="line" id="aF"></div>
    <div class="line" id="aS"></div>
    
    <div class="answer-container">
      <div class="answer-box" id="aE"></div>
    </div>
    
    <div class="trunc-line" id="aTrunc"></div>
    
    <div class="answer-container">
      <div class="answer-box" id="aN"></div>
    </div>
  </div>

  <div class="calc" id="volumeCalc">
    <h2>Volume</h2>
    <div class="line" id="vF"></div>
    <div class="line" id="vS"></div>
    
    <div class="answer-container">
      <div class="answer-box" id="vE"></div>
    </div>
    
    <div class="trunc-line" id="vTrunc"></div>
    
    <div class="answer-container">
      <div class="answer-box" id="vN"></div>
    </div>
  </div>
</div>

</section>
</div>

<script>
let r = 7;
let dp = 2;
let unit = null;
let dragging = false;
let fraction = 0;
let draggingFraction = false;
let answersVisible = false;

// REORDERED: millimeter first, then centimeter
const units = [
  {symbol:'', name:'units'},
  {symbol:'mm', name:'millimetre'},
  {symbol:'cm', name:'centimetre'},
  {symbol:'m', name:'metre'},
  {symbol:'km', name:'kilometre'}
];

const numline = document.getElementById("numline");
const numlineLabels = document.getElementById("numlineLabels");
const setInfo = document.getElementById("setInfo");
const valueInput = document.getElementById("valueInput");
const fractionLine = document.getElementById("fractionLine");
const fractionLineLabels = document.getElementById("fractionLineLabels");
const revealBtn = document.getElementById("revealBtn");
const surfaceAreaCalc = document.getElementById("surfaceAreaCalc");
const volumeCalc = document.getElementById("volumeCalc");

// Build fixed 0-11 number line
function buildNumline() {
  numline.innerHTML = '';
  numlineLabels.innerHTML = '';
  
  const low = 0;
  const high = 11;
  const range = high - low;
  
  // Add ticks and labels
  for (let i = low; i <= high; i++) {
    const pct = ((i - low) / range) * 100;
    const tick = document.createElement("div");
    tick.className = i === 0 ? "numline-tick zero" : "numline-tick";
    tick.style.left = pct + "%";
    numline.appendChild(tick);
    
    const lbl = document.createElement("span");
    lbl.textContent = i;
    lbl.style.flex = "1";
    lbl.style.textAlign = "center";
    numlineLabels.appendChild(lbl);
  }
  
  // Add draggable dot (integer part only)
  const dot = document.createElement("div");
  dot.className = "numline-dot";
  const integerPart = Math.floor(r);
  const integerPct = ((integerPart - low) / range) * 100;
  dot.style.left = integerPct + "%";
  numline.appendChild(dot);
  
  // Drag handlers for integer line
  dot.addEventListener("mousedown", startDragInteger);
  dot.addEventListener("touchstart", startDragInteger, {passive:false});
}

// Build 0-1 fraction line (RED)
function buildFractionLine() {
  fractionLine.innerHTML = '';
  fractionLineLabels.innerHTML = '';
  
  const low = 0;
  const high = 1;
  const range = high - low;
  
  // Add labels with mathematical notation
  const labels = [
    {pos: 0, label: "0"},
    {pos: 0.5, label: "½"},
    {pos: 1, label: "1"}
  ];
  
  labels.forEach(item => {
    const lbl = document.createElement("span");
    lbl.textContent = item.label;
    lbl.style.flex = "1";
    lbl.style.textAlign = "center";
    fractionLineLabels.appendChild(lbl);
  });
  
  // Add draggable dot
  const dot = document.createElement("div");
  dot.className = "fraction-line-dot";
  const fractionPct = (fraction / range) * 100;
  dot.style.left = fractionPct + "%";
  fractionLine.appendChild(dot);
  
  // Drag handlers for fraction line
  dot.addEventListener("mousedown", startDragFraction);
  dot.addEventListener("touchstart", startDragFraction, {passive:false});
}

// Integer line drag handlers
function startDragInteger(e) {
  e.preventDefault();
  dragging = true;
  document.addEventListener("mousemove", onDragInteger);
  document.addEventListener("mouseup", endDragInteger);
  document.addEventListener("touchmove", onDragInteger, {passive:false});
  document.addEventListener("touchend", endDragInteger);
}

function onDragInteger(e) {
  if (!dragging) return;
  e.preventDefault();
  const rect = numline.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  let pct = (clientX - rect.left) / rect.width;
  pct = Math.max(0, Math.min(1, pct));
  
  const low = 0;
  const high = 11;
  const range = high - low;
  
  let newInteger = low + pct * range;
  newInteger = Math.max(0, Math.min(11, newInteger));
  
  // Snap to integers with wider tolerance to encourage integer selection
  const snapTolerance = 0.15 * range;
  const nearestInt = Math.round(newInteger);
  
  if (Math.abs(newInteger - nearestInt) < snapTolerance) {
    newInteger = nearestInt;
  }
  
  const integerPart = Math.floor(newInteger);
  
  // When snapping to integer, cancel the fraction
  if (Math.abs(newInteger - nearestInt) < 0.1) {
    fraction = 0;
  }
  
  r = integerPart + fraction;
  valueInput.value = r.toFixed(2);
  update();
}

function endDragInteger() {
  dragging = false;
  document.removeEventListener("mousemove", onDragInteger);
  document.removeEventListener("mouseup", endDragInteger);
  document.removeEventListener("touchmove", onDragInteger);
  document.removeEventListener("touchend", endDragInteger);
}

// Fraction line drag handlers
function startDragFraction(e) {
  e.preventDefault();
  draggingFraction = true;
  document.addEventListener("mousemove", onDragFraction);
  document.addEventListener("mouseup", endDragFraction);
  document.addEventListener("touchmove", onDragFraction, {passive:false});
  document.addEventListener("touchend", endDragFraction);
}

function onDragFraction(e) {
  if (!draggingFraction) return;
  e.preventDefault();
  const rect = fractionLine.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  let pct = (clientX - rect.left) / rect.width;
  pct = Math.max(0, Math.min(1, pct));
  
  const low = 0;
  const high = 1;
  const range = high - low;
  
  let newFraction = low + pct * range;
  newFraction = Math.max(0, Math.min(1, newFraction));
  
  // Round to 2 decimal places for smoother dragging
  fraction = Math.round(newFraction * 100) / 100;
  
  // Update radius (integer + fraction)
  const integerPart = Math.floor(r);
  r = integerPart + fraction;
  valueInput.value = r.toFixed(2);
  update();
}

function endDragFraction() {
  draggingFraction = false;
  document.removeEventListener("mousemove", onDragFraction);
  document.removeEventListener("mouseup", endDragFraction);
  document.removeEventListener("touchmove", onDragFraction);
  document.removeEventListener("touchend", endDragFraction);
}

// Click handlers
numline.addEventListener("click", (e) => {
  if (e.target.classList.contains("numline-dot")) return;
  const rect = numline.getBoundingClientRect();
  let pct = (e.clientX - rect.left) / rect.width;
  pct = Math.max(0, Math.min(1, pct));
  
  const low = 0;
  const high = 11;
  const range = high - low;
  
  let newInteger = low + pct * range;
  newInteger = Math.max(0, Math.min(11, newInteger));
  
  // Always snap to nearest integer on click
  const nearestInt = Math.round(newInteger);
  const integerPart = nearestInt;
  
  // Reset fraction when clicking integer line
  fraction = 0;
  
  r = integerPart;
  valueInput.value = r.toFixed(2);
  update();
});

fractionLine.addEventListener("click", (e) => {
  if (e.target.classList.contains("fraction-line-dot")) return;
  const rect = fractionLine.getBoundingClientRect();
  let pct = (e.clientX - rect.left) / rect.width;
  pct = Math.max(0, Math.min(1, pct));
  
  const low = 0;
  const high = 1;
  const range = high - low;
  
  let newFraction = low + pct * range;
  newFraction = Math.max(0, Math.min(1, newFraction));
  
  fraction = Math.round(newFraction * 100) / 100;
  
  const integerPart = Math.floor(r);
  r = integerPart + fraction;
  valueInput.value = r.toFixed(2);
  update();
});

// Input field handler
valueInput.addEventListener("change", () => {
  let newValue = parseFloat(valueInput.value);
  if (isNaN(newValue)) newValue = 7;
  if (newValue < 0) newValue = 0;
  if (newValue > 11) newValue = 11;
  
  r = newValue;
  fraction = r - Math.floor(r);
  valueInput.value = r.toFixed(2);
  update();
});

valueInput.addEventListener("input", () => {
  let newValue = parseFloat(valueInput.value);
  if (!isNaN(newValue) && newValue >= 0 && newValue <= 11) {
    r = newValue;
    fraction = r - Math.floor(r);
    update();
  }
});

// Reveal/Hide button handler - uses blur effect
revealBtn.addEventListener("click", () => {
  answersVisible = !answersVisible;
  
  if (answersVisible) {
    revealBtn.textContent = "Hide";
    surfaceAreaCalc.classList.remove("hidden");
    volumeCalc.classList.remove("hidden");
  } else {
    revealBtn.textContent = "Reveal";
    surfaceAreaCalc.classList.add("hidden");
    volumeCalc.classList.add("hidden");
  }
});

// dp buttons 1–4
const dpWrap = document.getElementById("dpBtns");
[1,2,3,4].forEach(v => {
  const b = document.createElement("button");
  b.textContent = v;
  if (v === 2) b.classList.add("active");
  b.onclick = () => {
    document.querySelectorAll("#dpBtns button").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    dp = v;
    update();
  };
  dpWrap.appendChild(b);
});

// unit buttons - REORDERED
const unitWrap = document.getElementById("unitBtns");
units.forEach((u, idx) => {
  const b = document.createElement("button");
  b.textContent = u.symbol || 'units';
  b.title = u.name;
  if (idx === 0) b.classList.add("active");
  b.onclick = () => {
    document.querySelectorAll("#unitBtns button").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    unit = u;
    update();
  };
  unitWrap.appendChild(b);
});

function fmt(n, places) {
  const nearInt = Math.abs(n - Math.round(n)) < 1e-12;
  if (nearInt) return String(Math.round(n));
  return Number(n).toFixed(places);
}

// Get truncated decimal with rounding info
function getTruncatedWithRounding(n, places, unitStr) {
  const truncStr = n.toFixed(places + 1);
  const nextDigit = parseInt(truncStr[truncStr.length - 1], 10);
  const roundUp = nextDigit >= 5;
  
  // Show truncated to dp+1 with ellipsis
  const parts = truncStr.split('.');
  const intPart = parts[0];
  const decPart = parts[1];
  
  const arrow = roundUp ? '<span class="round-arrow round-up">↑</span>' : '<span class="round-arrow round-down">↓</span>';
  
  return `= ${intPart}.${decPart}…${unitStr} ${arrow}`;
}

function update() {
  buildNumline();
  buildFractionLine();
  
  const isInteger = Math.abs(fraction) < 0.001;
  const unitStr = unit && unit.symbol ? ' ' + unit.symbol : '';
  const unitStr2 = unit && unit.symbol ? ' ' + unit.symbol + '²' : '';
  const unitStr3 = unit && unit.symbol ? ' ' + unit.symbol + '³' : '';

  const rDisp = r.toFixed(2);
  
  document.getElementById("radiusDisplay").innerHTML = `<i>r</i> = ${rDisp}${unitStr}`;
  document.getElementById("rLabel").textContent = "r = " + rDisp + unitStr;
  
  // Update set notation
  if (isInteger && r >= 0) {
    setInfo.textContent = "Integer value radius (r ∈ ℤ⁺)";
    setInfo.className = "set-info integer";
  } else {
    setInfo.textContent = "Rational value radius (r ∈ ℚ)";
    setInfo.className = "set-info rational";
  }

  // Sphere formulas
  const a = 4 * Math.PI * r * r; // Surface area
  const v = (4/3) * Math.PI * r * r * r; // Volume

  const fourR2 = 4 * r * r;
  const fourThirdsR3 = (4/3) * r * r * r;

  const fourR2Disp = fmt(fourR2, 2);
  const fourThirdsR3Disp = fmt(fourThirdsR3, 4);

  // Surface Area - FORMULA LINES
  document.getElementById("aF").innerHTML = `<i>A</i> = 4π<i>r</i>²`;
  document.getElementById("aS").innerHTML = `= 4π × ${rDisp}²${unitStr2}`;
  
  // Surface Area - EXACT ANSWER
  document.getElementById("aE").innerHTML = 
    `<span class="label">A =</span> <span class="value">${fourR2Disp}π${unitStr2}</span> <span class="dp-info">(exact)</span>`;
  
  document.getElementById("aTrunc").innerHTML = getTruncatedWithRounding(a, dp, unitStr2);
  
  // Surface Area - ROUNDED ANSWER
  document.getElementById("aN").innerHTML = 
    `<span class="label">A =</span> <span class="value">${fmt(a, dp)}${unitStr2}</span> <span class="dp-info">(${dp} dp)</span>`;

  // Volume - FORMULA LINES
  document.getElementById("vF").innerHTML = `<i>V</i> = <sup>4</sup>⁄<sub>3</sub>π<i>r</i>³`;
  document.getElementById("vS").innerHTML = `= <sup>4</sup>⁄<sub>3</sub>π × ${rDisp}³${unitStr3}`;
  
  // Volume - EXACT ANSWER
  document.getElementById("vE").innerHTML = 
    `<span class="label">V =</span> <span class="value"><sup>4</sup>⁄<sub>3</sub>π × ${rDisp}³${unitStr3}</span> <span class="dp-info">(exact)</span>`;
  
  document.getElementById("vTrunc").innerHTML = getTruncatedWithRounding(v, dp, unitStr3);
  
  // Volume - ROUNDED ANSWER
  document.getElementById("vN").innerHTML = 
    `<span class="label">V =</span> <span class="value">${fmt(v, dp)}${unitStr3}</span> <span class="dp-info">(${dp} dp)</span>`;
}

// Add JavaScript timestamp for filename when saving
document.addEventListener('DOMContentLoaded', function() {
  // This will set a timestamp in the title when the page loads
  const now = new Date();
  const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
  document.title = `Sphere Calculator ${timestamp}`;
});

unit = units[0];
update();
</script>
</body>
</html>