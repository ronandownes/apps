<!DOCTYPE html>
<html lang="en">
<style>
    /* ... keeping your existing styles ... */
</style>
<body>
    <button class="mode-toggle" onclick="toggleNightMode()">‚òÄÔ∏è / üåô</button>

    <div class="calculator">
        <div class="header">
            <div class="brand">CASI-OH?</div>
            <div class="model">LIBERTY-1</div>
        </div>
        
        <div class="product-line">Number ¬∑ x¬≤ ¬∑ f(x) ¬∑ Trig ¬∑ Geom ¬∑ xÃÑ=11.2 ¬∑ P(win)=0.9</div>
        
        <div class="display-container">
            <div class="display-inner">
                <div class="mode-bar">
                    <span id="modeIndicator">COMP</span>
                    <span>NORM</span>
                    <span id="angleIndicator">DEG</span>
                </div>
                <div class="display-small" id="previousDisplay"></div>
                <div class="display" id="display">0</div>
            </div>
        </div>

        <div class="control-nav-row">
            <button class="ctrl-btn purple" onclick="toggleShift()">SHIFT</button>
            <button class="ctrl-btn purple" onclick="toggleAlpha()">ALPHA</button>
            <div class="nav-pad">
                <div class="nav-cross">
                    <button class="nav-btn nav-up"></button>
                    <button class="nav-btn nav-down"></button>
                    <button class="nav-btn nav-left"></button>
                    <button class="nav-btn nav-right"></button>
                    <button class="nav-btn nav-center"></button>
                </div>
            </div>
            <button class="ctrl-btn" onclick="toggleDegRad()">UNIT<br><span style="font-size:8px;">D/R</span></button>
            <button class="ctrl-btn" onclick="clearAll()">ON</button>
        </div>

        </div>

<script>
    let currentInput = '';
    let previousDisplay = '';
    let shiftMode = false;
    let alphaMode = false;
    let angleMode = 'deg';
    let lastAnswer = 0;

    const displayElement = document.getElementById('display');
    const prevDisplayElement = document.getElementById('previousDisplay');
    const angleElement = document.getElementById('angleIndicator');

    function updateDisplay() {
        displayElement.textContent = currentInput || '0';
        prevDisplayElement.textContent = previousDisplay;
        angleElement.textContent = angleMode.toUpperCase();
    }

    function insertChar(char) {
        if (currentInput === '0') currentInput = '';
        currentInput += char;
        updateDisplay();
    }

    function toggleShift() { shiftMode = !shiftMode; }
    function toggleAlpha() { alphaMode = !alphaMode; }
    
    function toggleDegRad() {
        angleMode = angleMode === 'deg' ? 'rad' : 'deg';
        updateDisplay();
    }

    function clearAll() {
        currentInput = '';
        previousDisplay = '';
        updateDisplay();
    }

    function deleteChar() {
        currentInput = currentInput.slice(0, -1);
        updateDisplay();
    }

    // --- LOGIC ENGINE ---

    function factorial(n) {
        if (n < 0) return NaN;
        if (n === 0 || n === 1) return 1;
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    function insertFunction(func) {
        if (shiftMode) {
            if (func === 'square') currentInput += 'fact(';
            else if (func === 'logbox') currentInput += '10^(';
            else if (func === 'power') currentInput += 'root(';
            shiftMode = false;
        } else {
            const map = {
                'sqrt': 'sqrt(',
                'square': '^2',
                'logbox': 'log(', // We'll handle as log(base, num)
                'log': 'log10(',
                'ln': 'ln(',
                'abs': 'abs(',
                'sin': 'sin(',
                'cos': 'cos(',
                'tan': 'tan('
            };
            currentInput += map[func] || '';
        }
        updateDisplay();
    }

    function calculateApprox() {
        try {
            let expr = currentInput;
            previousDisplay = expr + ' =';

            // 1. Handle Trig (Degrees vs Radians)
            const degToRad = (angleMode === 'deg') ? `* (Math.PI / 180)` : '';
            expr = expr.replace(/sin\(([^)]+)\)/g, `Math.sin(($1)${degToRad})`);
            expr = expr.replace(/cos\(([^)]+)\)/g, `Math.cos(($1)${degToRad})`);
            expr = expr.replace(/tan\(([^)]+)\)/g, `Math.tan(($1)${degToRad})`);

            // 2. Handle Custom Log: log(base, num) -> log(num)/log(base)
            expr = expr.replace(/log\(([^,]+),([^)]+)\)/g, `(Math.log($2)/Math.log($1))`);

            // 3. Handle General Math Functions
            expr = expr.replace(/sqrt\(/g, 'Math.sqrt(');
            expr = expr.replace(/log10\(/g, 'Math.log10(');
            expr = expr.replace(/ln\(/g, 'Math.log(');
            expr = expr.replace(/abs\(/g, 'Math.abs(');
            expr = expr.replace(/fact\(([^)]+)\)/g, 'factorial($1)');
            
            // 4. Operators
            expr = expr.replace(/√ó/g, '*').replace(/√∑/g, '/');
            expr = expr.replace(/\^/g, '**');

            // 5. Implicit Multiplication (e.g., 2(5) -> 2*(5))
            expr = expr.replace(/(\d)\(/g, '$1*(');
            expr = expr.replace(/\)(\d)/g, ')*$1');

            let result = eval(expr);
            
            // Format result
            if (!isFinite(result)) throw "Math Error";
            currentInput = Number.isInteger(result) ? result.toString() : result.toFixed(6).replace(/\.?0+$/, "");
            lastAnswer = result;

        } catch (e) {
            currentInput = "Math Error";
        }
        updateDisplay();
    }
</script>
</body>
</html>