<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cuboid Calculator</title>

<style>
:root{--ink:#000;--line:#cfcfcf;--muted:#666;--blue:#2563eb}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#fff;color:var(--ink)}
.wrap{max-width:1100px;margin:6px auto;padding:0 6px}
.card{border:1px solid var(--line);border-radius:10px;padding:12px}

.block{border:1px solid var(--line);border-radius:8px;padding:8px}

.top-controls{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.mode-row{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f9f9f9;border-radius:8px;flex-wrap:wrap}
.mode-label{font-size:14px;font-weight:600;margin-right:8px}
.mode-btn{border:2px solid var(--line);border-radius:6px;background:#fff;padding:6px 14px;font-size:13px;cursor:pointer;font-weight:500;transition:all 0.2s}
.mode-btn:hover{background:#f0f0f0}
.mode-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}

.unit-row{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f9f9f9;border-radius:8px}
.unit-label{font-size:14px;font-weight:600}
.unit-select{border:2px solid var(--line);border-radius:6px;padding:5px 8px;font-size:13px;background:#fff;cursor:pointer}
.unit-select:focus{outline:none;border-color:var(--blue)}

.mix-toggle{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f9f9f9;border-radius:8px;cursor:pointer}
.mix-toggle input{width:18px;height:18px;cursor:pointer}
.mix-toggle label{font-size:13px;cursor:pointer;user-select:none}

.input-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.input-block{flex:1;min-width:140px;display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 14px}
.input-block h3{margin:0;font-size:13px}
.input-controls{display:flex;align-items:center;gap:4px}
.value-input{width:70px;border:2px solid var(--blue);border-radius:6px;padding:6px 8px;font-size:20px;text-align:center;font-family:"Times New Roman",Times,serif;font-weight:bold}
.value-input:focus{outline:none;border-color:#000}
.value-input.locked{background:#f0f0f0;border-color:#999}
.arrow-buttons{display:flex;flex-direction:column;gap:2px}
.arrow-btn{width:28px;height:22px;border:2px solid var(--line);border-radius:4px;background:#fff;cursor:pointer;font-size:14px;font-weight:bold;display:flex;align-items:center;justify-content:center;user-select:none}
.arrow-btn:hover{background:#f0f0f0}
.arrow-btn:active{background:#e0e0e0}
.arrow-btn.hidden{visibility:hidden}

.dim-unit-select{border:2px solid var(--line);border-radius:6px;padding:4px 6px;font-size:12px;background:#fff;cursor:pointer;margin-left:6px}
.dim-unit-select:disabled{background:#f0f0f0;color:#999;cursor:not-allowed}
.dim-unit-select:focus{outline:none;border-color:var(--blue)}

.input-display{font-family:"Times New Roman",Times,serif;font-size:16px;margin-top:4px}

.diagram-container{display:flex;justify-content:center;padding:5px;margin:5px 0}
.diagram-container svg{max-width:600px;width:100%;height:auto}

.not-to-scale{text-align:center;font-size:11px;color:#888;font-style:italic;margin-top:0;margin-bottom:8px}

.calcs-container{max-width:750px;margin:0 auto}

.calc-section{margin-top:16px}

.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:10px}
.section-title{font-size:22px;font-weight:bold}
.section-buttons{display:flex;gap:6px}

.calc{border:2px solid var(--line);border-radius:8px;padding:18px;margin-top:8px;background:#fff}
.work-line{display:flex;justify-content:space-between;align-items:center;margin:14px 0;min-height:44px}
.line-num{font-family:"Times New Roman",Times,serif;font-size:18px;color:#888;min-width:36px;text-align:right;margin-right:14px}
.math-content{font-family:"Times New Roman",Times,serif;font-size:32px;font-weight:bold;flex:1}
.logic-hint{font-family:Segoe UI,Arial,sans-serif;font-size:17px;color:var(--blue);font-style:italic;font-weight:600;margin-left:24px;white-space:nowrap;text-align:right}

.calc-note{font-size:13px;color:#666;font-style:italic;margin-top:12px;padding-top:10px;border-top:1px dashed #ddd}
.calc-note strong{color:#333}

.concept-box{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:8px;padding:12px 16px;margin-top:12px}
.concept-text{font-size:15px;color:#555;line-height:1.6}
.concept-text .pair{display:inline;margin:0 8px}
.concept-text strong{color:#1a4d8c}

.answer-box{display:inline-block;border:3px solid #000;padding:12px 18px;font-family:"Times New Roman",Times,serif;font-size:34px;font-weight:bold}
.answer-box .label{font-style:italic}

.blurred{filter:blur(4px)}

.reveal-btn{border:2px solid var(--line);border-radius:6px;background:#fff;font-size:14px;padding:6px 16px;cursor:pointer;font-weight:600}
.reveal-btn:hover{background:#f5f5f5}

@media(max-width:700px){
  .input-row{flex-direction:column}
  .input-block{width:100%;max-width:none}
  .math-content{font-size:20px}
  .formula-large{font-size:26px}
}
</style>
</head>

<body>
<div class="wrap">
<section class="card">

<div class="top-controls">
  <div class="mode-row">
    <span class="mode-label">Shape:</span>
    <button class="mode-btn active" id="modeClosedBtn">Cuboid (Closed)</button>
    <button class="mode-btn" id="modeOpenBtn">Cuboid (Open-top)</button>
    <button class="mode-btn" id="modeCubeBtn">Cube</button>
  </div>
  
  <div class="unit-row">
    <span class="unit-label">Common Unit:</span>
    <select class="unit-select" id="unitSelect">
      <option value="km">km</option>
      <option value="m" selected>m</option>
      <option value="cm">cm</option>
      <option value="mm">mm</option>
    </select>
  </div>
  
  <div class="mix-toggle">
    <input type="checkbox" id="mixUnitsCheck">
    <label for="mixUnitsCheck">Mix Units</label>
  </div>
  
  <div class="mix-toggle">
    <input type="checkbox" id="drawModeCheck">
    <label for="drawModeCheck">‚úèÔ∏è Draw Mode</label>
  </div>
</div>

<!-- Drawing canvas overlay -->
<canvas id="drawCanvas" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;cursor:crosshair;touch-action:none;"></canvas>
<div id="drawControls" style="display:none;position:fixed;top:10px;right:10px;z-index:1001;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);">
  <button onclick="clearCanvas()" style="padding:6px 12px;margin-right:6px;cursor:pointer;">Clear</button>
  <button onclick="toggleDrawMode()" style="padding:6px 12px;cursor:pointer;">Exit Draw</button>
  <input type="color" id="penColor" value="#ff0000" style="margin-left:10px;cursor:pointer;">
  <select id="penSize" style="margin-left:6px;padding:4px;">
    <option value="2">Thin</option>
    <option value="4" selected>Medium</option>
    <option value="8">Thick</option>
  </select>
</div>

<div class="input-row">
  <div class="block input-block" id="widthBlock">
    <h3 id="widthLabel">Width (w)</h3>
    <div class="input-controls">
      <input type="number" class="value-input" id="widthInput" min="0.1" step="0.1" value="2">
      <div class="arrow-buttons">
        <button class="arrow-btn" id="widthUp">‚ñ≤</button>
        <button class="arrow-btn" id="widthDown">‚ñº</button>
      </div>
      <select class="dim-unit-select" id="wUnitSelect" disabled>
        <option value="km">km</option>
        <option value="m" selected>m</option>
        <option value="cm">cm</option>
        <option value="mm">mm</option>
      </select>
    </div>
    <div class="input-display" id="widthDisplay"><i>w</i> = 2 m</div>
  </div>
  
  <div class="block input-block" id="heightBlock">
    <h3 id="heightLabel">Height (h)</h3>
    <div class="input-controls">
      <input type="number" class="value-input" id="heightInput" min="0.1" step="0.1" value="3">
      <div class="arrow-buttons" id="heightArrows">
        <button class="arrow-btn" id="heightUp">‚ñ≤</button>
        <button class="arrow-btn" id="heightDown">‚ñº</button>
      </div>
      <select class="dim-unit-select" id="hUnitSelect" disabled>
        <option value="km">km</option>
        <option value="m" selected>m</option>
        <option value="cm">cm</option>
        <option value="mm">mm</option>
      </select>
    </div>
    <div class="input-display" id="heightDisplay"><i>h</i> = 3 m</div>
  </div>
  
  <div class="block input-block" id="depthBlock">
    <h3 id="depthLabel">Depth (d)</h3>
    <div class="input-controls">
      <input type="number" class="value-input" id="depthInput" min="0.1" step="0.1" value="4">
      <div class="arrow-buttons" id="depthArrows">
        <button class="arrow-btn" id="depthUp">‚ñ≤</button>
        <button class="arrow-btn" id="depthDown">‚ñº</button>
      </div>
      <select class="dim-unit-select" id="dUnitSelect" disabled>
        <option value="km">km</option>
        <option value="m" selected>m</option>
        <option value="cm">cm</option>
        <option value="mm">mm</option>
      </select>
    </div>
    <div class="input-display" id="depthDisplay"><i>d</i> = 4 m</div>
  </div>
</div>

<div class="diagram-container" id="diagramContainer"></div>
<div class="not-to-scale">Not to scale ‚Äî <strong>Copy this diagram into your copybook first!</strong></div>

<div class="calcs-container">
  <!-- SURFACE AREA -->
  <div class="calc-section">
    <div class="section-header">
      <span class="section-title">Surface Area of Cuboid</span>
      <div class="section-buttons">
        <button class="reveal-btn" id="hideA">Hide</button>
        <button class="reveal-btn" id="showA" style="display:none;">Show</button>
        <button class="reveal-btn" id="stepA" style="display:none;">Step by Step</button>
        <button class="reveal-btn" id="nextA" style="display:none;">Next</button>
      </div>
    </div>
    
    <div class="calc" id="areaCalc">
      <div class="work-line" id="aLine0"><span class="line-num">(1)</span><div class="math-content" id="aFormula"></div><div class="logic-hint">Formula</div></div>
      <div class="work-line" id="aLine1"><span class="line-num">(2)</span><div class="math-content" id="aS1"></div><div class="logic-hint">Substitute</div></div>
      <div class="work-line" id="aLine2"><span class="line-num">(3)</span><div class="math-content" id="aS2"></div><div class="logic-hint" id="aHint2">Simplified</div></div>
      <div class="work-line" id="aLine3"><span class="line-num">(4)</span><div class="math-content" id="aS3"></div><div class="logic-hint" id="aHint3">Double half-cuboid</div></div>
      <div class="work-line" id="aLine4"><span class="line-num">(5)</span><div class="answer-box" id="aN"></div><div class="logic-hint">Answer</div></div>
      <div class="calc-note">üí° <strong>Calculator shortcut:</strong> Type line (2) exactly into your calculator to skip to line (5)</div>
    </div>
    
    <div class="concept-box" id="conceptBoxA">
      <div class="concept-text" id="conceptText">
        <strong>Understanding:</strong> Three pairs of congruent faces ‚Äî <span class="pair">Top ‚âÖ Bottom</span> <span class="pair">Front ‚âÖ Back</span> <span class="pair">Left ‚âÖ Right</span> ‚Äî so we double the semi-surface area.
      </div>
    </div>
  </div>

  <!-- VOLUME -->
  <div class="calc-section">
    <div class="section-header">
      <span class="section-title">Volume of Cuboid</span>
      <div class="section-buttons">
        <button class="reveal-btn" id="hideV">Hide</button>
        <button class="reveal-btn" id="showV" style="display:none;">Show</button>
        <button class="reveal-btn" id="stepV" style="display:none;">Step by Step</button>
        <button class="reveal-btn" id="nextV" style="display:none;">Next</button>
      </div>
    </div>
    
    <div class="calc" id="volumeCalc">
      <div class="work-line" id="vLine0"><span class="line-num">(1)</span><div class="math-content" id="vFormula"></div><div class="logic-hint">Formula</div></div>
      <div class="work-line" id="vLine1"><span class="line-num">(2)</span><div class="math-content" id="vS1"></div><div class="logic-hint">Substitute</div></div>
      <div class="work-line" id="vLine2"><span class="line-num">(3)</span><div class="math-content" id="vS2"></div><div class="logic-hint">Calculate</div></div>
      <div class="work-line" id="vLine3"><span class="line-num">(4)</span><div class="answer-box" id="vN"></div><div class="logic-hint">Answer</div></div>
      <div class="calc-note">üí° <strong>Calculator shortcut:</strong> Type line (2) exactly into your calculator to skip to line (4)</div>
    </div>
    
    <div class="concept-box" id="conceptBoxV">
      <div class="concept-text" id="volConceptText"><strong>Understanding:</strong> Volume = Width √ó Height √ó Depth (the space inside the cuboid)</div>
    </div>
  </div>
</div>

</section>
</div>

<script>
let w = 2, h = 3, d = 4;
let unit = 'm';
let wUnit = 'm', hUnit = 'm', dUnit = 'm';
let mixUnits = false;
let mode = 'closed';
let aStage = -1, vStage = -1;

function makeCuboidSVG(wVal, hVal, dVal, wU, hU, dU, isCube, isOpen) {
  const svgW = 580, svgH = 260;
  
  let wPx, hPx, dPx;
  
  if(isCube) {
    wPx = 130;
    hPx = 130;
    dPx = 90;
  } else {
    wPx = 280;
    hPx = 90;  // shorter height
    dPx = 90;
  }
  
  const angle = 30;
  const rad = angle * Math.PI / 180;
  const dx = dPx * Math.cos(rad);
  const dy = dPx * Math.sin(rad);
  
  const baseX = isCube ? 160 : 100;
  const baseY = svgH - 55;
  
  const p1 = {x: baseX, y: baseY};
  const p2 = {x: baseX + wPx, y: baseY};
  const p3 = {x: baseX + wPx, y: baseY - hPx};
  const p4 = {x: baseX, y: baseY - hPx};
  const p5 = {x: baseX + dx, y: baseY - dy};
  const p6 = {x: baseX + wPx + dx, y: baseY - dy};
  const p7 = {x: baseX + wPx + dx, y: baseY - hPx - dy};
  const p8 = {x: baseX + dx, y: baseY - hPx - dy};

  let svg = `<svg viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
  
  // Back edges (dashed)
  svg += `<line x1="${p5.x}" y1="${p5.y}" x2="${p8.x}" y2="${p8.y}" stroke="#aaa" stroke-width="1.5" stroke-dasharray="6,4"/>`;
  svg += `<line x1="${p5.x}" y1="${p5.y}" x2="${p1.x}" y2="${p1.y}" stroke="#aaa" stroke-width="1.5" stroke-dasharray="6,4"/>`;
  svg += `<line x1="${p5.x}" y1="${p5.y}" x2="${p6.x}" y2="${p6.y}" stroke="#aaa" stroke-width="1.5" stroke-dasharray="6,4"/>`;
  
  // Front face - lightest
  svg += `<polygon points="${p1.x},${p1.y} ${p2.x},${p2.y} ${p3.x},${p3.y} ${p4.x},${p4.y}" fill="#f5f5f5" stroke="#000" stroke-width="2"/>`;
  
  // Side face - medium
  svg += `<polygon points="${p2.x},${p2.y} ${p6.x},${p6.y} ${p7.x},${p7.y} ${p3.x},${p3.y}" fill="#d0d0d0" stroke="#000" stroke-width="2"/>`;
  
  // Top face - darker than front
  if(isOpen) {
    svg += `<polygon points="${p4.x},${p4.y} ${p3.x},${p3.y} ${p7.x},${p7.y} ${p8.x},${p8.y}" fill="none" stroke="#c00" stroke-width="2.5" stroke-dasharray="8,5"/>`;
    const topCX = (p4.x + p3.x + p7.x + p8.x) / 4;
    const topCY = (p4.y + p3.y + p7.y + p8.y) / 4;
    svg += `<text x="${topCX}" y="${topCY + 5}" font-size="16" font-family="Segoe UI" fill="#c00" text-anchor="middle" font-weight="bold">OPEN</text>`;
  } else {
    svg += `<polygon points="${p4.x},${p4.y} ${p3.x},${p3.y} ${p7.x},${p7.y} ${p8.x},${p8.y}" fill="#dcdcdc" stroke="#000" stroke-width="2"/>`;
  }
  
  // DIMENSION LABELS
  // Width (w) - below the front bottom edge
  const wLabelX = (p1.x + p2.x) / 2;
  const wLabelY = p1.y + 30;
  if(isCube) {
    svg += `<text x="${wLabelX}" y="${wLabelY}" font-size="22" font-family="Times New Roman" fill="#000" text-anchor="middle"><tspan font-weight="bold" font-style="italic">s</tspan> = ${wVal} ${wU}</text>`;
  } else {
    svg += `<text x="${wLabelX}" y="${wLabelY}" font-size="22" font-family="Times New Roman" fill="#000" text-anchor="middle"><tspan font-weight="bold" font-style="italic">w</tspan> = ${wVal} ${wU}</text>`;
  }
  
  // Height (h) - to the LEFT of the front left edge
  const hLabelX = p1.x - 15;
  const hLabelY = (p1.y + p4.y) / 2 + 5;
  if(!isCube) {
    svg += `<text x="${hLabelX}" y="${hLabelY}" font-size="22" font-family="Times New Roman" fill="#000" text-anchor="end"><tspan font-weight="bold" font-style="italic">h</tspan> = ${hVal} ${hU}</text>`;
  }
  
  // Depth (d) - halfway along the bottom-right edge, offset outward
  const dEdgeMidX = (p2.x + p6.x) / 2;
  const dEdgeMidY = (p2.y + p6.y) / 2;
  const dLabelX = dEdgeMidX + 15;
  const dLabelY = dEdgeMidY + 20;
  if(!isCube) {
    svg += `<text x="${dLabelX}" y="${dLabelY}" font-size="22" font-family="Times New Roman" fill="#000"><tspan font-weight="bold" font-style="italic">d</tspan> = ${dVal} ${dU}</text>`;
  }
  
  // FACE LABELS with formulas - bigger and bolder
  const frontCX = (p1.x + p2.x + p3.x + p4.x) / 4;
  const frontCY = (p1.y + p2.y + p3.y + p4.y) / 4;
  if(isCube) {
    svg += `<text x="${frontCX}" y="${frontCY - 5}" font-size="16" font-family="Segoe UI" fill="#333" text-anchor="middle">Front</text>`;
  } else {
    svg += `<text x="${frontCX}" y="${frontCY - 10}" font-size="17" font-family="Segoe UI" fill="#333" text-anchor="middle" font-weight="600">Front</text>`;
    svg += `<text x="${frontCX}" y="${frontCY + 14}" font-size="18" font-family="Times New Roman" fill="#000" text-anchor="middle" font-weight="bold" font-style="italic">(wh)</text>`;
  }
  
  const sideCX = (p2.x + p6.x + p7.x + p3.x) / 4;
  const sideCY = (p2.y + p6.y + p7.y + p3.y) / 4;
  if(isCube) {
    svg += `<text x="${sideCX}" y="${sideCY}" font-size="16" font-family="Segoe UI" fill="#333" text-anchor="middle">Side</text>`;
  } else {
    svg += `<text x="${sideCX}" y="${sideCY - 10}" font-size="17" font-family="Segoe UI" fill="#333" text-anchor="middle" font-weight="600">Side</text>`;
    svg += `<text x="${sideCX}" y="${sideCY + 14}" font-size="18" font-family="Times New Roman" fill="#000" text-anchor="middle" font-weight="bold" font-style="italic">(hd)</text>`;
  }
  
  if(!isOpen) {
    const topCX = (p4.x + p3.x + p7.x + p8.x) / 4;
    const topCY = (p4.y + p3.y + p7.y + p8.y) / 4;
    if(isCube) {
      svg += `<text x="${topCX}" y="${topCY + 5}" font-size="16" font-family="Segoe UI" fill="#333" text-anchor="middle">Top</text>`;
    } else {
      svg += `<text x="${topCX}" y="${topCY - 5}" font-size="17" font-family="Segoe UI" fill="#333" text-anchor="middle" font-weight="600">Top</text>`;
      svg += `<text x="${topCX}" y="${topCY + 17}" font-size="18" font-family="Times New Roman" fill="#000" text-anchor="middle" font-weight="bold" font-style="italic">(wd)</text>`;
    }
  }
  
  if(isCube) {
    svg += `<text x="${svgW - 30}" y="30" font-size="14" font-family="Segoe UI" fill="#666" text-anchor="end" font-style="italic">All edges equal</text>`;
  }
  
  svg += `</svg>`;
  return svg;
}

// Mode buttons
document.getElementById("modeClosedBtn").onclick = () => setMode('closed');
document.getElementById("modeOpenBtn").onclick = () => setMode('open');
document.getElementById("modeCubeBtn").onclick = () => setMode('cube');

function setMode(newMode) {
  mode = newMode;
  document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
  if(mode === 'closed') document.getElementById("modeClosedBtn").classList.add("active");
  if(mode === 'open') document.getElementById("modeOpenBtn").classList.add("active");
  if(mode === 'cube') document.getElementById("modeCubeBtn").classList.add("active");
  
  const hInput = document.getElementById("heightInput");
  const dInput = document.getElementById("depthInput");
  
  if(mode === 'cube') {
    h = w; d = w;
    hInput.value = w; dInput.value = w;
    hInput.classList.add("locked"); dInput.classList.add("locked");
    hInput.readOnly = true; dInput.readOnly = true;
    document.querySelectorAll("#heightArrows .arrow-btn, #depthArrows .arrow-btn").forEach(b => b.classList.add("hidden"));
    document.getElementById("widthLabel").textContent = "Side (s)";
    document.getElementById("heightLabel").textContent = "Side (s)";
    document.getElementById("depthLabel").textContent = "Side (s)";
    mixUnits = false;
    document.getElementById("mixUnitsCheck").checked = false;
    document.getElementById("mixUnitsCheck").disabled = true;
    document.getElementById("wUnitSelect").disabled = true;
    document.getElementById("hUnitSelect").disabled = true;
    document.getElementById("dUnitSelect").disabled = true;
    wUnit = unit; hUnit = unit; dUnit = unit;
    document.getElementById("wUnitSelect").value = unit;
    document.getElementById("hUnitSelect").value = unit;
    document.getElementById("dUnitSelect").value = unit;
  } else {
    hInput.classList.remove("locked"); dInput.classList.remove("locked");
    hInput.readOnly = false; dInput.readOnly = false;
    document.querySelectorAll("#heightArrows .arrow-btn, #depthArrows .arrow-btn").forEach(b => b.classList.remove("hidden"));
    document.getElementById("widthLabel").textContent = "Width (w)";
    document.getElementById("heightLabel").textContent = "Height (h)";
    document.getElementById("depthLabel").textContent = "Depth (d)";
    document.getElementById("mixUnitsCheck").disabled = false;
  }
  
  updateFormulas();
  update();
}

function updateFormulas() {
  if(mode === 'cube') {
    document.getElementById("conceptText").innerHTML = `<strong>Understanding:</strong> Six identical square faces ‚Äî so we multiply one face area by 6.`;
    document.getElementById("volConceptText").innerHTML = `<strong>Understanding:</strong> Volume = Side √ó Side √ó Side (the space inside the cube)`;
    document.querySelector(".section-title").textContent = "Surface Area of Cube";
    document.querySelectorAll(".section-title")[1].textContent = "Volume of Cube";
  } else if(mode === 'open') {
    document.getElementById("conceptText").innerHTML = `<strong>Understanding:</strong> Two pairs of congruent faces + one base ‚Äî <span class="pair">Front ‚âÖ Back</span> <span class="pair">Left ‚âÖ Right</span> <span class="pair">+ Bottom</span>`;
    document.getElementById("volConceptText").innerHTML = `<strong>Understanding:</strong> Volume = Width √ó Height √ó Depth (the space inside)`;
    document.querySelector(".section-title").textContent = "Surface Area of Open-top Cuboid";
    document.querySelectorAll(".section-title")[1].textContent = "Volume of Cuboid";
  } else {
    document.getElementById("conceptText").innerHTML = `<strong>Understanding:</strong> Three pairs of congruent faces ‚Äî <span class="pair">Top ‚âÖ Bottom</span> <span class="pair">Front ‚âÖ Back</span> <span class="pair">Left ‚âÖ Right</span> ‚Äî so we double the semi-surface area.`;
    document.getElementById("volConceptText").innerHTML = `<strong>Understanding:</strong> Volume = Width √ó Height √ó Depth (the space inside the cuboid)`;
    document.querySelector(".section-title").textContent = "Surface Area of Cuboid";
    document.querySelectorAll(".section-title")[1].textContent = "Volume of Cuboid";
  }
}

// Mix units toggle
document.getElementById("mixUnitsCheck").onchange = function() {
  mixUnits = this.checked;
  document.getElementById("wUnitSelect").disabled = !mixUnits;
  document.getElementById("hUnitSelect").disabled = !mixUnits;
  document.getElementById("dUnitSelect").disabled = !mixUnits;
  
  if(!mixUnits) {
    wUnit = unit; hUnit = unit; dUnit = unit;
    document.getElementById("wUnitSelect").value = unit;
    document.getElementById("hUnitSelect").value = unit;
    document.getElementById("dUnitSelect").value = unit;
  }
  update();
};

// Common unit select
document.getElementById("unitSelect").onchange = function() {
  unit = this.value;
  mixUnits = false;
  document.getElementById("mixUnitsCheck").checked = false;
  document.getElementById("wUnitSelect").disabled = true;
  document.getElementById("hUnitSelect").disabled = true;
  document.getElementById("dUnitSelect").disabled = true;
  wUnit = unit; hUnit = unit; dUnit = unit;
  document.getElementById("wUnitSelect").value = unit;
  document.getElementById("hUnitSelect").value = unit;
  document.getElementById("dUnitSelect").value = unit;
  update();
};

// Individual unit selects
document.getElementById("wUnitSelect").onchange = function() { wUnit = this.value; if(mode==='cube'){hUnit=wUnit;dUnit=wUnit;document.getElementById("hUnitSelect").value=wUnit;document.getElementById("dUnitSelect").value=wUnit;} update(); };
document.getElementById("hUnitSelect").onchange = function() { if(mode!=='cube'){hUnit = this.value; update();} };
document.getElementById("dUnitSelect").onchange = function() { if(mode!=='cube'){dUnit = this.value; update();} };

// Input controls - allow decimals
const wIn = document.getElementById("widthInput");
const hIn = document.getElementById("heightInput");
const dIn = document.getElementById("depthInput");

document.getElementById("widthUp").onclick = () => { w++; wIn.value = w; if(mode==='cube'){h=w;d=w;hIn.value=w;dIn.value=w;} update(); };
document.getElementById("widthDown").onclick = () => { w = Math.max(0.1, w-1); wIn.value = w; if(mode==='cube'){h=w;d=w;hIn.value=w;dIn.value=w;} update(); };
wIn.oninput = () => { let v=parseFloat(wIn.value); if(!isNaN(v)&&v>0){w=v; if(mode==='cube'){h=w;d=w;hIn.value=w;dIn.value=w;} update();} };

document.getElementById("heightUp").onclick = () => { if(mode!=='cube'){h++;hIn.value=h;update();} };
document.getElementById("heightDown").onclick = () => { if(mode!=='cube'){h=Math.max(0.1,h-1);hIn.value=h;update();} };
hIn.oninput = () => { if(mode!=='cube'){let v=parseFloat(hIn.value);if(!isNaN(v)&&v>0){h=v;update();}} };

document.getElementById("depthUp").onclick = () => { if(mode!=='cube'){d++;dIn.value=d;update();} };
document.getElementById("depthDown").onclick = () => { if(mode!=='cube'){d=Math.max(0.1,d-1);dIn.value=d;update();} };
dIn.oninput = () => { if(mode!=='cube'){let v=parseFloat(dIn.value);if(!isNaN(v)&&v>0){d=v;update();}} };

// Reveal button handlers - Surface Area
document.getElementById("hideA").onclick = () => {
  document.getElementById("areaCalc").classList.add("blurred");
  document.getElementById("hideA").style.display = "none";
  document.getElementById("showA").style.display = "inline-block";
  document.getElementById("stepA").style.display = "inline-block";
  aStage = -1;
};

document.getElementById("showA").onclick = () => {
  document.getElementById("areaCalc").classList.remove("blurred");
  showAllArea();
  document.getElementById("hideA").style.display = "inline-block";
  document.getElementById("showA").style.display = "none";
  document.getElementById("stepA").style.display = "none";
  document.getElementById("nextA").style.display = "none";
  aStage = -1;
};

document.getElementById("stepA").onclick = () => {
  aStage = -1;
  hideAllArea();
  document.getElementById("areaCalc").classList.remove("blurred");
  document.getElementById("showA").style.display = "none";
  document.getElementById("stepA").style.display = "none";
  document.getElementById("hideA").style.display = "inline-block";
  document.getElementById("nextA").style.display = "inline-block";
};

document.getElementById("nextA").onclick = () => {
  aStage++;
  if(aStage > 4) {
    showAllArea();
    document.getElementById("nextA").style.display = "none";
  } else {
    showAreaStage(aStage);
  }
};

// Reveal button handlers - Volume
document.getElementById("hideV").onclick = () => {
  document.getElementById("volumeCalc").classList.add("blurred");
  document.getElementById("hideV").style.display = "none";
  document.getElementById("showV").style.display = "inline-block";
  document.getElementById("stepV").style.display = "inline-block";
  vStage = -1;
};

document.getElementById("showV").onclick = () => {
  document.getElementById("volumeCalc").classList.remove("blurred");
  showAllVolume();
  document.getElementById("hideV").style.display = "inline-block";
  document.getElementById("showV").style.display = "none";
  document.getElementById("stepV").style.display = "none";
  document.getElementById("nextV").style.display = "none";
  vStage = -1;
};

document.getElementById("stepV").onclick = () => {
  vStage = -1;
  hideAllVolume();
  document.getElementById("volumeCalc").classList.remove("blurred");
  document.getElementById("showV").style.display = "none";
  document.getElementById("stepV").style.display = "none";
  document.getElementById("hideV").style.display = "inline-block";
  document.getElementById("nextV").style.display = "inline-block";
};

document.getElementById("nextV").onclick = () => {
  vStage++;
  if(vStage > 3) {
    showAllVolume();
    document.getElementById("nextV").style.display = "none";
  } else {
    showVolumeStage(vStage);
  }
};

function hideAllArea() { for(let i=0;i<=4;i++) document.getElementById("aLine"+i).classList.add("blurred"); }
function showAllArea() { for(let i=0;i<=4;i++) document.getElementById("aLine"+i).classList.remove("blurred"); }
function showAreaStage(s) { for(let i=0;i<=4;i++) { if(i<=s) document.getElementById("aLine"+i).classList.remove("blurred"); else document.getElementById("aLine"+i).classList.add("blurred"); } }
function hideAllVolume() { for(let i=0;i<=3;i++) document.getElementById("vLine"+i).classList.add("blurred"); }
function showAllVolume() { for(let i=0;i<=3;i++) document.getElementById("vLine"+i).classList.remove("blurred"); }
function showVolumeStage(s) { for(let i=0;i<=3;i++) { if(i<=s) document.getElementById("vLine"+i).classList.remove("blurred"); else document.getElementById("vLine"+i).classList.add("blurred"); } }

function update() {
  const isCube = (mode === 'cube'), isOpen = (mode === 'open');
  
  // Get display units
  const wu = mixUnits ? wUnit : unit;
  const hu = mixUnits ? hUnit : unit;
  const du = mixUnits ? dUnit : unit;
  
  document.getElementById("diagramContainer").innerHTML = makeCuboidSVG(w, h, d, wu, hu, du, isCube, isOpen);
  
  if(isCube) {
    document.getElementById("widthDisplay").innerHTML = `<i>s</i> = ${w} ${wu}`;
    document.getElementById("heightDisplay").innerHTML = `<i>s</i> = ${w} ${wu}`;
    document.getElementById("depthDisplay").innerHTML = `<i>s</i> = ${w} ${wu}`;
  } else {
    document.getElementById("widthDisplay").innerHTML = `<i>w</i> = ${w} ${wu}`;
    document.getElementById("heightDisplay").innerHTML = `<i>h</i> = ${h} ${hu}`;
    document.getElementById("depthDisplay").innerHTML = `<i>d</i> = ${d} ${du}`;
  }

  // Helper to round and clean up floating point
  function r(n) {
    return Math.round(n * 10000) / 10000;
  }
  function fmt(n) {
    const rounded = r(n);
    if(Number.isInteger(rounded)) return rounded.toString();
    return parseFloat(rounded.toFixed(4)).toString();
  }

  // Unit conversion factors (to metres as base)
  const toMetres = { 'km': 1000, 'm': 1, 'cm': 0.01, 'mm': 0.001 };
  const unitOrder = ['km', 'm', 'cm', 'mm'];
  
  // Determine calculation unit and convert values
  let calcUnit, wCalc, hCalc, dCalc;
  
  if(mixUnits && !isCube) {
    // Find the most common unit, or middle unit if all different
    const units = [wUnit, hUnit, dUnit];
    const unitCounts = {};
    units.forEach(u => unitCounts[u] = (unitCounts[u] || 0) + 1);
    
    // Find unit with most occurrences
    let maxCount = 0;
    let mostCommon = null;
    for(let u in unitCounts) {
      if(unitCounts[u] > maxCount) {
        maxCount = unitCounts[u];
        mostCommon = u;
      }
    }
    
    // If all different, pick the middle one by size
    if(maxCount === 1) {
      // Convert all to metres, find middle
      const inMetres = [
        { unit: wUnit, val: w * toMetres[wUnit] },
        { unit: hUnit, val: h * toMetres[hUnit] },
        { unit: dUnit, val: d * toMetres[dUnit] }
      ];
      inMetres.sort((a, b) => a.val - b.val);
      mostCommon = inMetres[1].unit; // middle value's unit
    }
    
    calcUnit = mostCommon;
    
    // Convert all values to calcUnit
    wCalc = r((w * toMetres[wUnit]) / toMetres[calcUnit]);
    hCalc = r((h * toMetres[hUnit]) / toMetres[calcUnit]);
    dCalc = r((d * toMetres[dUnit]) / toMetres[calcUnit]);
  } else {
    calcUnit = unit;
    wCalc = w;
    hCalc = h;
    dCalc = d;
  }
  
  const u2 = calcUnit + '¬≤';
  const u3 = calcUnit + '¬≥';

  const front = r(wCalc*hCalc), top = r(wCalc*dCalc), side = r(hCalc*dCalc), vol = r(wCalc*hCalc*dCalc);
  let area;
  
  // Show conversion note if units were converted
  let conversionNote = '';
  if(mixUnits && !isCube) {
    const conversions = [];
    if(wUnit !== calcUnit) conversions.push(`${w} ${wUnit} = ${fmt(wCalc)} ${calcUnit}`);
    if(hUnit !== calcUnit) conversions.push(`${h} ${hUnit} = ${fmt(hCalc)} ${calcUnit}`);
    if(dUnit !== calcUnit) conversions.push(`${d} ${dUnit} = ${fmt(dCalc)} ${calcUnit}`);
    if(conversions.length > 0) {
      conversionNote = `<div style="font-size:14px;color:#666;margin-bottom:10px;padding:8px;background:#fff8e0;border-radius:4px;">‚ö†Ô∏è <strong>Converting to ${calcUnit}:</strong> ${conversions.join(', ')}</div>`;
    }
  }
  
  if(isCube) {
    const s2 = r(wCalc*wCalc);
    area = r(6*s2);
    document.getElementById("aFormula").innerHTML = `<i>A</i> = 6<i>s</i>¬≤`;
    document.getElementById("aS1").innerHTML = `<i>A</i> = 6 √ó ${fmt(wCalc)}¬≤`;
    document.getElementById("aS2").innerHTML = `<i>A</i> = 6 √ó ${fmt(s2)}`;
    document.getElementById("aHint2").textContent = "One face area";
    document.getElementById("aS3").innerHTML = `<i>A</i> = ${fmt(area)}`;
    document.getElementById("aHint3").textContent = "√ó 6 faces";
    document.getElementById("vFormula").innerHTML = `<i>V</i> = <i>s</i>¬≥`;
    document.getElementById("vS1").innerHTML = `<i>V</i> = ${fmt(wCalc)}¬≥`;
    document.getElementById("vS2").innerHTML = `<i>V</i> = ${fmt(vol)}`;
  } else if(isOpen) {
    area = r(2*front + 2*side + top);
    document.getElementById("aFormula").innerHTML = `<i>A</i> = 2<i>wh</i> + 2<i>hd</i> + <i>wd</i>`;
    document.getElementById("aS1").innerHTML = `${conversionNote}<i>A</i> = 2(${fmt(wCalc)}√ó${fmt(hCalc)}) + 2(${fmt(hCalc)}√ó${fmt(dCalc)}) + (${fmt(wCalc)}√ó${fmt(dCalc)})`;
    document.getElementById("aS2").innerHTML = `<i>A</i> = 2(${fmt(front)}) + 2(${fmt(side)}) + ${fmt(top)}`;
    document.getElementById("aHint2").textContent = "Face areas";
    document.getElementById("aS3").innerHTML = `<i>A</i> = ${fmt(r(2*front))} + ${fmt(r(2*side))} + ${fmt(top)} = ${fmt(area)}`;
    document.getElementById("aHint3").textContent = "5 faces total";
    document.getElementById("vFormula").innerHTML = `<i>V</i> = <i>w</i> √ó <i>h</i> √ó <i>d</i>`;
    document.getElementById("vS1").innerHTML = `<i>V</i> = ${fmt(wCalc)} √ó ${fmt(hCalc)} √ó ${fmt(dCalc)}`;
    document.getElementById("vS2").innerHTML = `<i>V</i> = ${fmt(vol)}`;
  } else {
    const sum = r(front + top + side);
    area = r(2*sum);
    document.getElementById("aFormula").innerHTML = `<i>A</i> = 2(<i>wh</i> + <i>wd</i> + <i>hd</i>)`;
    document.getElementById("aS1").innerHTML = `${conversionNote}<i>A</i> = 2(${fmt(wCalc)}√ó${fmt(hCalc)} + ${fmt(wCalc)}√ó${fmt(dCalc)} + ${fmt(hCalc)}√ó${fmt(dCalc)})`;
    document.getElementById("aS2").innerHTML = `<i>A</i> = 2(${fmt(front)} + ${fmt(top)} + ${fmt(side)})`;
    document.getElementById("aHint2").textContent = "Simplified";
    document.getElementById("aS3").innerHTML = `<i>A</i> = 2(${fmt(sum)}) = ${fmt(area)}`;
    document.getElementById("aHint3").textContent = "Double half-cuboid";
    document.getElementById("vFormula").innerHTML = `<i>V</i> = <i>w</i> √ó <i>h</i> √ó <i>d</i>`;
    document.getElementById("vS1").innerHTML = `<i>V</i> = ${fmt(wCalc)} √ó ${fmt(hCalc)} √ó ${fmt(dCalc)}`;
    document.getElementById("vS2").innerHTML = `<i>V</i> = ${fmt(vol)}`;
  }
  
  document.getElementById("aN").innerHTML = `<span class="label">A = </span>${fmt(area)} ${u2}`;
  document.getElementById("vN").innerHTML = `<span class="label">V = </span>${fmt(vol)} ${u3}`;
}

// KEYBOARD / CLICKER SUPPORT
document.addEventListener('keydown', function(e) {
  if(e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ' || e.key === 'PageDown' || e.key === 'Enter') {
    e.preventDefault();
    advanceStep();
  }
  if(e.key === 'ArrowLeft' || e.key === 'ArrowUp' || e.key === 'PageUp' || e.key === 'Backspace') {
    e.preventDefault();
    goBackStep();
  }
});

function advanceStep() {
  const nextA = document.getElementById("nextA");
  const nextV = document.getElementById("nextV");
  const stepA = document.getElementById("stepA");
  const stepV = document.getElementById("stepV");
  const hideA = document.getElementById("hideA");
  const hideV = document.getElementById("hideV");
  
  if(nextA.style.display !== "none") { nextA.click(); }
  else if(nextV.style.display !== "none") { nextV.click(); }
  else if(stepA.style.display !== "none") { stepA.click(); }
  else if(stepV.style.display !== "none") { stepV.click(); }
  else if(hideA.style.display !== "none") { hideA.click(); }
  else if(hideV.style.display !== "none") { hideV.click(); }
}

function goBackStep() {
  const nextA = document.getElementById("nextA");
  const nextV = document.getElementById("nextV");
  
  if(nextA.style.display !== "none" && aStage >= 0) {
    aStage--;
    if(aStage < 0) hideAllArea(); else showAreaStage(aStage);
  } else if(nextV.style.display !== "none" && vStage >= 0) {
    vStage--;
    if(vStage < 0) hideAllVolume(); else showVolumeStage(vStage);
  }
}

// Initialize
updateFormulas();
update();

// DRAWING MODE for Surface Pro pen / stylus
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
let isDrawing = false;
let lastX = 0, lastY = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function toggleDrawMode() {
  const check = document.getElementById('drawModeCheck');
  check.checked = !check.checked;
  updateDrawMode();
}

function updateDrawMode() {
  const enabled = document.getElementById('drawModeCheck').checked;
  canvas.style.display = enabled ? 'block' : 'none';
  document.getElementById('drawControls').style.display = enabled ? 'block' : 'none';
  if(enabled) resizeCanvas();
}

document.getElementById('drawModeCheck').onchange = updateDrawMode;

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function getPos(e) {
  if(e.touches && e.touches.length > 0) {
    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  return { x: e.clientX, y: e.clientY };
}

function startDraw(e) {
  isDrawing = true;
  const pos = getPos(e);
  lastX = pos.x;
  lastY = pos.y;
}

function draw(e) {
  if(!isDrawing) return;
  e.preventDefault();
  const pos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(pos.x, pos.y);
  ctx.strokeStyle = document.getElementById('penColor').value;
  ctx.lineWidth = document.getElementById('penSize').value;
  ctx.lineCap = 'round';
  ctx.stroke();
  lastX = pos.x;
  lastY = pos.y;
}

function stopDraw() {
  isDrawing = false;
}

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDraw);
canvas.addEventListener('mouseout', stopDraw);

canvas.addEventListener('touchstart', startDraw, {passive: false});
canvas.addEventListener('touchmove', draw, {passive: false});
canvas.addEventListener('touchend', stopDraw);

window.addEventListener('resize', () => { if(canvas.style.display !== 'none') resizeCanvas(); });
</script>
</body>
</html>
